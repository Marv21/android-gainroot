package at.fhooe.mc.gainroot.exploits;

import android.util.Log;
import at.fhooe.mc.gainroot.R;
import at.fhooe.mc.gainroot.essentials.Exploit;

/**
 * Special implementation of an 'exploit'.<br>
 * This one will remove the <i>su binary</i> and the <i>superUser.apk</i> with
 * the native compiled script <i>uninstallsu</i>.
 * 
 * @author Gerald Schoiber
 * @version 1.0
 * @see Log, Exploit
 */
public class Unroot extends Exploit {

	public Unroot() {
		super(
				R.raw.uninstallsu, // id
				"Uninstall Root", // name
				"every version", // versions
				"Gerald Schoiber", // author
				"2013", // date
				"remove Superuser.apk\n"
						+ "After this, your device will no longer have permanent root\n\n"
						+ "You will need to give the unroot process root privilege!", // info
				null); // resources
	}

	/**
	 * Run the unroot process withthe {@link Runtime} method, wait for the
	 * return value and tell the user about if it has been worked.
	 * 
	 * @see Boolean, Integer, Log, Process, Exception, Runtime, Thread,
	 *      showProgressDialog(String, String), getName(), showToast(String),
	 *      finish()
	 */
	@Override
	public void run() {
		showProgressDialog(getName(), "unroot device");
		Log.d(TAG, "unroot device ...");
		try {
			Thread.sleep(1000); // cause it is so quick in execution, that the
								// UI has no chance to shown up
			Log.d(TAG, m_path + getResources().getResourceEntryName(getId()));
			java.lang.Process proc = Runtime.getRuntime().exec(
					"su -c " + m_path
							+ getResources().getResourceEntryName(getId()));

			int val = proc.waitFor();
			Log.d(TAG, "unroot return: " + val);
			if (val == 0) {
				finish(true);
				return;
			}
		} catch (Exception e) {
			Log.e(TAG, e.getMessage());
			showToast("unrooting fail, no root?");
		}
		finish(false);
	}

	/**
	 * Have to overwrite this method for the 'special' <i>unroot</i> message :D.
	 * 
	 * @param True
	 *            if all went OK, false otherwise.
	 * @see Boolean, finish(), showDialog(String, String), getName()
	 */
	@Override
	public void finish(boolean _succsess) {
		if (this.m_pd != null)
			this.m_pd.dismiss();
		if (_succsess)
			showDialog(getName(), "successfully unroot!");
		else
			showDialog(getName(), "failure, no root? :(");
	}

}
