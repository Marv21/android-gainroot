#include <stdio.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <sys/mount.h>
#include <sys/time.h>
#include <linux/netlink.h>
#include <sys/socket.h>
#include <sys/un.h>
#include <arpa/inet.h>
#include <unistd.h>
#include <fcntl.h>
#include <errno.h>
#include <string.h>
#include <signal.h>
#include <stdlib.h>
#include <math.h>
#include <dlfcn.h>
#include <elf.h>
#include <sys/system_properties.h>
#include <android/log.h>

#include <stdio.h>
#include <sys/types.h>
#include <linux/netlink.h>
#include <fcntl.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/stat.h>
#include <signal.h>
#include <sys/mount.h>
#include <jni.h>
#include <android/log.h>

#define printf(...)  __android_log_print(ANDROID_LOG_DEBUG  , "installSU", __VA_ARGS__)

char *SU_BIN = "/data/data/at.fhooe.mc.gainroot/files/su";
char *SU_APK = "/data/data/at.fhooe.mc.gainroot/files/superuser";

int copy(const char *from, const char *to)
{
  int fd1, fd2;
  char buf[0x1000];
  int r = 0;

  if ((fd1 = open(from, O_RDONLY)) < 0)
    return -1;
  if ((fd2 = open(to, O_RDWR|O_CREAT|O_TRUNC, 0600)) < 0) {
    close(fd1);
    return -1;
  }

  for (;;) {
    r = read(fd1, buf, sizeof(buf));
    if (r <= 0)
      break;
    if (write(fd2, buf, r) != r)
      break;
  }

  close(fd1);
  close(fd2);
  sync(); sync();
  return r;
}

/**
 * Install Superuser.apk
 * by Gerald Schoiber
 * 
 * used modified version of exploit framework
 *  Copyright (c) 2011 Sebastian HÃ¶barth, Rene Mayrhofe
 */
int main(int argc, char **argv, char **env){
  printf("Android local root framework\n");
  printf("by _erebos_\n");
  printf("----------------------------------------\n");
  printf("[*] tries to make root permanent, if uid is 0\n");
  printf("[*] will install Superuser.apk\n");
  printf("[+] EUID=%d UID=%d\n",geteuid(),getuid());
  
  //check if we got called from a root process
  if(geteuid() == 0 && getuid() == 0){
    
    //Get current directory of the mount partition system
    FILE* output1;
    char str1[128];
    char str2[128];
    char str3[128];
    output1 = fopen("/proc/mounts", "r");
    while (!feof(output1))
    {
      fscanf(output1, "%s %s %s\n", &str1, &str2, &str3);
      if(strstr(str2,"/system") != NULL )
	break;
    }
    fclose(output1);
    
    //Mount the file system read write able
    if (mount(str2, "/system", NULL, MS_REMOUNT, 0) < 0)
    {
      printf("[-] remount didnt worked\n");
      printf("[-] we do not have the opportunity make root permanent");
      printf("[-] exit without installing anything");
      exit(-1);
    }
    else
    {
      printf("[+] remount successful\n");

      //Get the full path of the binary file
      char myself[128];
      memset(myself, 0, sizeof(myself));
      readlink("/proc/self/exe", myself, sizeof(myself));
      printf("[+] I am = %s\n",myself);
	
      //install su binary
      if(copy(SU_BIN, "/system/xbin/su") < 0)
      {
	printf("[-] cant copy su binary\n");
	printf("[-] exit without installing anything");
	exit(-1);
      }
      else
      {
	printf("[+] copy su binary successful\n");
	
	//change owner
	if (chown("/system/xbin/su", 0, 0) != 0)
	{
	  printf("[-] cant change owner of su binary\n");
	  printf("[-] exit");
	  exit(-1);
	}
	else
	{
	  printf("[+] changing owner of su binary was successful\n");
	}
	
	if (chmod("/system/xbin/su", 06755) != 0)
	{
	  printf("[-] cant make su binary executable\n");
	  printf("[-] exit");
	  exit(-1);
	}
	else
	{
	  printf("[+] making su binary executable was successful\n");
	}
      }
      
      //install Superuser.apk
      if(copy(SU_APK, "/system/app/Superuser.apk") < 0)
      {
	printf("[-] cant copy Superuser.apk\n");
	printf("[-] exit without installing Superuser.apk");
	exit(-1);
      }
      else
      {
	printf("[+] copy Superuser.apk successful\n");
	
	if (chmod("/system/app/Superuser.apk", 655) != 0)
	{
	  printf("[-] cant modify Superuser.apk file\n");
	  printf("[-] exit");
	  exit(-1);
	}
	else
	{
	  printf("[+] modified was successful\n");
	}
      }
    }
  }else{
    printf("[-] we do not have the opportunity make root permanent");
    printf("[-] exit without installing anything");
    exit(-1);
  }
  
  exit(0);
} 
