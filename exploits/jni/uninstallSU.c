#include <stdio.h>
#include <sys/types.h>
#include <linux/netlink.h>
#include <fcntl.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/stat.h>
#include <signal.h>
#include <sys/mount.h>
#include <jni.h>
#include <android/log.h>

#define printf(...)  __android_log_print(ANDROID_LOG_DEBUG  , "installSU", __VA_ARGS__)

/**
 * Uninstall Superuser.apk
 * by Gerald Schoiber
 */
int main(int argc, char **argv, char **env){
  printf("Android local root framework\n");
  printf("by _erebos_\n");
  printf("----------------------------------------\n");
  printf("[*] unroot device\n");
  printf("[*] will remove Superuser.apk\n");
  printf("[+] EUID=%d UID=%d\n",geteuid(),getuid());
  
  //check if we got called from a root process
  if(geteuid() == 0 && getuid() == 0){
    
    //Get current directory of the mount partition system
    FILE* output1;
    char str1[128];
    char str2[128];
    char str3[128];
    output1 = fopen("/proc/mounts", "r");
    while (!feof(output1))
    {
      fscanf(output1, "%s %s %s\n", &str1, &str2, &str3);
      if(strstr(str2,"/system") != NULL )
	break;
    }
    fclose(output1);
    
    //Mount the file system read write able
    if (mount(str2, "/system", NULL, MS_REMOUNT, 0) < 0)
    {
      printf("[-] remount didnt worked\n");
      printf("[-] no root?");
      printf("[-] exit without removing");
      exit(-1);
    }
    else
    {
      printf("[+] remount successful\n");

      //Get the full path of the binary file
      char myself[128];
      memset(myself, 0, sizeof(myself));
      readlink("/proc/self/exe", myself, sizeof(myself));
      printf("[+] I am = %s\n",myself);
	
      //remove su binary
      if (remove("/system/bin/su") != 0)
      {
	printf("[-] cant remove su binary\n");
	printf("[-] exit without removing anything");
	exit(-1);
      }
      else
      {
	printf("[+] removing su binary wasa successful\n");
      }
      
      //install Superuser.apk
      if(remove("/system/app/Superuser.apk") != 0)
      {
	printf("[-] cant remove Superuser.apk\n");
	printf("[-] exit without removing Superuser.apk");
	exit(-1);
      }
      else
      {
	printf("[+] removing Superuser.apk was successful\n");
      }
    }
  }else{
    printf("[-] we do not have the opportunity make root permanent");
    printf("[-] exit without installing anything");
    exit(-1);
  }
  
  exit(0);
}